include:
  - '/gitlab/ci/sast.yml'
  - '/gitlab/ci/unit.yml'
  - '/gitlab/ci/integration.yml'
  - '/gitlab/ci/template.yml'
  - '/gitlab/ci/misc.yml'

stages:
  - test
  - visual_pre
  - integration
  - compare
  - accessibility
  - unit
  - style
  - ci_checks
  - sast

image: domjudge/gitlabci:2.1

.retry_time: &normal_job
  <<: *clean_ordering
  timeout: 15m

webstandard_check_role:
  <<: *matrix_retry_job
  <<: *short_job
  <<: *maria_db
  parallel:
    matrix:
      - ROLE: public
        TEST: [w3cval,WCAG2A,WCAG2AA]
      - ROLE: team
        TEST: [w3cval,WCAG2A,WCAG2AA]
      - ROLE: balloon
        TEST: [w3cval,WCAG2A,WCAG2AA]
      - ROLE: jury
        TEST: [w3cval]
      - ROLE: admin
        TEST: [w3cval]
  stage: accessibility
  image: domjudge/gitlabci:2.1
  variables:
    MYSQL_ROOT_PASSWORD: password
  script:
    - ./gitlab/webstandard.sh
  artifacts:
    when: always
    paths:
      - public
      - w3chtmlpublic.json
      - w3ccsspublic.json
      - w3csvgpublic.json

visual_pr:
  <<: *retry_job
  <<: *long_job
  <<: *maria_db
  stage: visual_pre
  image: domjudge/gitlabci:2.1
  variables:
    MYSQL_ROOT_PASSWORD: password
    DOCKER_HOST: tcp://docker:2375/
    DOCKER_DRIVER: overlay2
  parallel:
    matrix:
      - URL: team
        ROLE: [jury,admin,team]
      - URL: public
        ROLE: [none,jury,admin,balloon,team]
  script:
    - git fetch
    - git config --global user.email "never@commits.ci"
    - git config --global user.name "Rebase against main"
    - echo -e "section_start:`date +%s`:diff[collapsed=true]\r\e[0K'Git Diff'"
    - git diff origin/main
    - echo -e "section_end:`date +%s`:diff\r\e[0K"
    - git pull origin main
    - ./gitlab/visualpr.sh pr
  artifacts:
    when: always
    paths:
      - screenshotspr
      - html
      - wget.log

visual_main:
  <<: *retry_job
  <<: *long_job
  <<: *maria_db
  stage: visual_pre
  image: domjudge/gitlabci:2.1
  variables:
    MYSQL_ROOT_PASSWORD: password
    DOCKER_HOST: tcp://docker:2375/
    DOCKER_DRIVER: overlay2
  parallel:
    matrix:
      - URL: team
        ROLE: [jury,admin,team]
      - URL: public
        ROLE: [none,jury,admin,balloon,team]
  script:
    - git fetch
    - git checkout -B main origin/main
    - git branch --set-upstream-to=origin/main main
    - git pull
    - git checkout $CI_COMMIT_SHA -- gitlab/visualpr.sh # Always compare with the same tests
    - git checkout $CI_COMMIT_SHA -- gitlab/default-nginx
    - git checkout $CI_COMMIT_SHA -- gitlab/visualreg.css
    - ./gitlab/visualpr.sh main
  artifacts:
    when: always
    paths:
      - screenshotsmain
      - html

visual_compare:
  <<: *retry_job
  <<: *normal_job
  stage: compare
  image: domjudge/gitlabci:2.1
  needs:
    - visual_pr
    - visual_main
  script:
    - ./gitlab/visualcompare.sh
  artifacts:
    when: always
    paths:
      - visualchanges
      - addrem.log

draw_graph:
  stage: ci_checks
  image: devdemisto/matplotlib:1.0.0.24512
  script:
    - ls duration
    - python3 showtimedata.py
  artifacts:
    paths:
      - time.png
      - duration
