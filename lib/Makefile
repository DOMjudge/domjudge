ifndef TOPDIR
TOPDIR=..
endif

REC_TARGETS = domserver

include $(TOPDIR)/Makefile.global

OBJECTS = $(addsuffix $(OBJEXT),lib.error lib.misc)

build: $(OBJECTS)

$(OBJECTS): %$(OBJEXT): %.c %.h

clean-l:
	rm -f $(OBJECTS)

# Change baseDir in composer autogenerated files
define fix_composer_paths
	for file in autoload_psr4.php autoload_classmap.php autoload_files.php autoload_namespaces.php ; do \
		sed -i "s#^\$$baseDir = .*#\$$baseDir = dirname('$(domserver_webappdir)');#" $(1)/composer/$$file ; \
	done
	sed -i "s#__DIR__ \. '/\.\./\.\./\.\.' \. '/webapp#'$(domserver_webappdir)#" $(1)/composer/autoload_static.php
endef

install-domserver:
	$(INSTALL_DATA) -t $(DESTDIR)$(domserver_libdir)    *.php
	$(INSTALL_PROG) -t $(DESTDIR)$(domserver_libdir)    alert
	for i in vendor/* ; do \
		$(call install_tree,$(DESTDIR)$(domserver_libvendordir),$$i) ; \
	done
	$(call fix_composer_paths,$(DESTDIR)$(domserver_libvendordir))

install-judgehost:
	$(INSTALL_DATA) -t $(DESTDIR)$(judgehost_libdir)    *.php *.sh
	$(INSTALL_PROG) -t $(DESTDIR)$(judgehost_libdir)    alert

domserver:         SUBDIRS=vendor
