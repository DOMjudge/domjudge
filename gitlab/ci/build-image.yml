# Build the DOMjudge image
# Used for visual testing, unit -, and integration.

build_containers:
  needs: []
  stage: build
  image: docker:dind
  variables:
    MYSQL_ROOT_PASSWORD: password
  services:
    - docker:dind
  script:
    - ./gitlab/build_ci_container.sh

visual_pr:
  stage: visual_pre
  needs: [build_containers]
  image: docker:dind
  services:
    - name: $CI_REGISTRY/domjudge/domjudge/mariadb:$CI_COMMIT_SHA
      alias: sqlserver
  image: $CI_REGISTRY/domjudge/domjudge/domserver:$CI_COMMIT_SHA
  script:
    - gitlab/buildimage/scripts/start.sh
    - service nginx status
    - echo "show databases;" | sudo mysql -hsqlserver -ppassword -uroot
