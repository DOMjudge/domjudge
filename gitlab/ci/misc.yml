check static codecov:
  extends: [.tiny_job]
  stage: ci_checks
  image: bash
  script:
    - wget https://codecov.io/bash -O newcodecov
    - diff newcodecov gitlab/uploadcodecov.sh

phpcs_compatibility:
  extends: [.tiny_job]
  stage: style
  image: pipelinecomponents/php-codesniffer:latest
  parallel:
    matrix:
      - PHPVERSION: ["7.4","8.1"]
  script:
    - phpcs --config-set installed_paths /app/vendor/phpcompatibility/php-compatibility
    - >
      phpcs -s -p --colors
      --standard=PHPCompatibility
      --extensions=php
      --runtime-set testVersion $PHPVERSION
      lib/lib.*.php
      etc
      judge
      webapp/src
      webapp/tests
      webapp/public
      webapp/config

# This finds different problems from codesniffer
php linter:
  extends: [.tiny_job]
  stage: style
  image: pipelinecomponents/php-linter:latest
  script:
    - >
      parallel-lint --colors
      lib/lib.*.php
      etc
      judge
      webapp/src
      webapp/tests
      webapp/public
      webapp/config

detect dump:
  extends: [.tiny_job]
  image: bash
  stage: style
  script:
    - OUT=$(find ./
        -name ".git" -type d -prune -o
        -name "cache" -type d -prune -o
        -name "ace" -type d -prune -o
        -type f -print0 | xargs -0 grep --color "dump(" | grep -v "Yaml::dump(")
    - echo $OUT
    - exit $(($(wc -l <<< $OUT)-1))

run chroot script checks:
  extends: [.normal_job]
  stage: chroot_checks
  when: manual
  allow_failure: true
  parallel:
    matrix:
      - PLACEHOLDER:
        - trigger_with_default_values
      - ARCH:
        - amd64
        - arm64
        - armhf
        - i386
  script:
    - ./gitlab/chroot_checks.sh

