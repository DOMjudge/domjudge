{# @var \App\Entity\ExternalJudgement externalJudgement #}
{% extends "jury/base.html.twig" %}

{% block title %}Submission s{{ submission.submitid }} - {{ parent() }}{% endblock %}

{% block extrahead %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/nv.d3.min.css') }}">
    <script src="{{ asset('js/d3.min.js') }}"></script>
    <script src="{{ asset('js/nv.d3.min.js') }}"></script>
    <script src="{{ asset('js/FileSaver.min.js') }}"></script>
    <style>
        .judging-table td a, .judging-table td a:hover {
            display: block;
            text-decoration: none;
            color: inherit;
        }

        .judging-table tr.disabled td a {
            color: silver
        }
    </style>
{% endblock %}

{% block content %}

    {% if submission.externalJudgements.empty %}
        {% set externalJudgement = null %}
    {% else %}
        {% set externalJudgement = submission.externalJudgements.first %}
    {% endif %}

    {% if claimWarning %}
        <div class="alert alert-warning">
            {{ claimWarning }}
        </div>
    {% endif %}

    {% if requestedOutputCount %}
        <div class="alert alert-warning">
            Waiting for {{ requestedOutputCount }} team output(s) (or full debug package) to be grabbed and uploaded.
        </div>
    {% endif %}

    {% if selectedJudging is not null and selectedJudging.result is not empty and submission.expectedResults %}
        {% if selectedJudging.result|upper not in submission.expectedResults %}
            <div class="alert alert-danger">
                Actual result {{ selectedJudging.result | printValidJuryResult }} does NOT match expected result(s):
                {% for expectedResult in submission.expectedResults %}
                    {{ expectedResult | printValidJuryResult }}
                    {% if not loop.last %}or{% endif %}
                {% endfor %}.
            </div>
        {% elseif submission.expectedResults|length > 1 %}
            <div class="alert alert-warning">
                Actual result {{ selectedJudging.result | printValidJuryResult }} matches one of multiple expected results:
                {% for expectedResult in submission.expectedResults %}
                    {{ expectedResult | printValidJuryResult }}
                    {% if not loop.last %}or{% endif %}
                {% endfor %}.
            </div>
        {% else %}
            <div class="alert alert-success">
                Actual result matches the expected result ({{ selectedJudging.result | printValidJuryResult }}).
            </div>
        {% endif %}
    {% endif %}

    {% if version_warnings is not null and version_warnings is not empty %}
        {% for type, versions in version_warnings %}
            <div class="alert alert-warning">
                <p>
                    This judging did not use the same {{ type}} version for all testcases.
                    This may lead to unexpected results. Versions used:
                </p>
                <p>
                    {% for version in versions %}
                            <pre class="output_text">{{ version }}</pre>
                            {% if not loop.last %}<hr />{% endif %}
                    {% endfor %}
                </p>
            </div>
        {% endfor %}
    {% endif %}

    <div class="card">
        <div class="card-header">
            <h1 style="display: inline;">
                Submission s{{ submission.submitid }}
                {% if submission.originalSubmission %}
                    {% set origSubmissionUrl = path('jury_submission', {submitId: submission.originalSubmission.submitid}) %}
                    (resubmit of <a href="{{ origSubmissionUrl }}">s{{ submission.originalSubmission.submitid }}</a>)
                {% endif %}
                {% if submission.resubmissions is not empty %}
                    (resubmitted as
                    {%- for resubmission in submission.resubmissions -%}
                        {% set resubmissionUrl = path('jury_submission', {submitId: resubmission.submitid}) %}
                        <a href="{{ resubmissionUrl }}">s{{ resubmission.submitid }}</a>
                        {%- if not loop.last -%},{%- endif -%}
                    {%- endfor -%}
                    )
                {% endif %}
                {% if not submission.valid %}
                    (ignored)
                {% endif %}
            </h1>
            {% if not submission.importError %}
                <div style="float: right;">
                    {% if is_granted('ROLE_ADMIN') %}
                        {% if submission.valid %}
                            {% set action = 'ignore' %}
                        {% else %}
                            {% set action = 'unignore' %}
                        {% endif %}
                        <form action="{{ path('jury_submission_update_status', {'submitId': submission.submitid}) }}" method="post"
                              style="display: inline; ">
                            <input type="hidden" name="valid" value="{% if submission.valid %}0{% else %}1{% endif %}"/>
                            <input type="submit" class="btn btn-outline-secondary btn-sm"
                                   value="{{ action | upper }} this submission"
                                   onclick="return confirm('Really {{ action }} submission s{{ submission.submitid }}?');"/>
                        </form>
                    {% endif %}

                    {% include 'jury/partials/rejudge_form.html.twig' with {table: 'submission', id: submission.submitid} %}
                </div>
            {% endif %}

            {# Condensed submission info on a single line with icons #}
            <div class="submission-summary mb-2">
                <span>
                    <i class="fas fa-users" title="Team:"></i>
                    <a href="{{ path('jury_team', {teamId: submission.team.teamid, cid: submission.contest.cid}) }}">
                        {{ submission.team.effectiveName }} {{ submission.team | entityIdBadge('t') }}
                    </a>
                </span>

                {% if submission.user %}
                    <span>
                        <i class="fas fa-user" title="User:"></i>
                        <a href="{{ path('jury_user', {userId: submission.user.userid, cid: submission.contest.cid}) }}">
                            {{ submission.user.username }} {{ submission.user | entityIdBadge('u') }}
                        </a>
                    </span>
                {% endif %}

                {% if current_contest.cid != submission.contest.cid %}
                    <span>
                        <i class="fas fa-trophy" title="Contest:"></i>
                        <a href="{{ path('jury_contest', {'contestId': submission.contest.cid}) }}">
                            {{ submission.contest.shortname }}
                            {{ submission.contest | entityIdBadge('c') }}
                        </a>
                    </span>
                {% endif %}

                <span>
                    <i class="fas fa-book-open" title="Problem:"></i>
                    <a href="{{ path('jury_problem', {'probId': submission.problem.probid}) }}">
                        {% if submission.contestProblem %}
                            {{ submission.contestProblem | problemBadge }} {{ submission.problem.name }}
                        {% else %}
                            {{ submission.problem.name }}
                        {% endif %}
                        {{ submission.problem | entityIdBadge('p') }}
                    </a>
                </span>

                <span>
                    <i class="fas fa-comments" title="Language:"></i>
                    <a href="{{ path('jury_language', {'langId': submission.language.langid}) }}">
                        {{ submission.language.name }}
                        {{ submission.language | entityIdBadge }}
                    </a>
                </span>

                <span>
                    <i class="fas fa-clock" title="Submittime:"></i>
                    <span title="{{ submission.submittime | printtime('Y-m-d H:i:s (T)') }}">
                        {{ submission.submittime | printtime(null, submission.contest) }}
                    </span>
                </span>

                <span>
                    <i class="fas fa-stopwatch" title="Allowed runtime:"></i>
                    {{ submission.problem.timelimit * submission.language.timeFactor }}s
                </span>

                <span>
                    <i class="fas fa-code" title="Source code:"></i>
                    <a href="{{ path('jury_submission_source', {submission: submission.submitid}) }}">
                        View {{ submission.files | printFiles }}
                    </a>
                </span>

                {% if external_ccs_submission_url is not empty %}
                    {% set externalSubmissionUrl = submission | externalCcsUrl %}
                    {% if externalSubmissionUrl is not empty %}
                        <span>
                    <i class="fas fa-link" title="External link:"></i>
                    <a href="{{ externalSubmissionUrl }}" target="_blank">
                        View in external CCS
                    </a>
                </span>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
    <br />

    {% if not submission.valid %}
        <div class="alert alert-danger">This submission is not used during scoreboard calculations.</div>
    {% endif %}

    {% if submission.importError %}
        <div class="alert alert-danger">
            <div>This submission could not be imported into DOMjudge and thus will only show external data.</div>
            <div>The error during import was: <code>{{ submission.importError }}</code></div>
        </div>
    {% endif %}

    {% if not submission.contestProblem %}
        <div class="alert alert-danger">
            This submission is for a problem that is not part (anymore) of the contest of the submission.
        </div>
    {% endif %}

    {% if shadowMode() and submission.externalid %}
        <div class="mb-2">
            External ID:
            {% if external_ccs_submission_url is empty %}
                {{- submission.externalid -}}
            {% else %}
                <a href="{{ submission | externalCcsUrl }}" target="_blank">
                    {{- submission.externalid -}}
                </a>
            {%- endif -%}
            {%- if externalJudgement is not null -%}
                , {{ externalJudgement.result | printValidJuryResult }}
            {% endif %}
        </div>
    {% endif %}

    {% if externalJudgement is not null and externalJudgement.result is not empty and (
        (selectedJudging is not null and selectedJudging.result is not empty and externalJudgement.result != selectedJudging.result)
        or submission.importError) %}
        <div class="alert alert-danger">
            <strong>Results differ!</strong>
            <hr>
            <p>
                This submission was judged as
                {% if external_ccs_submission_url is empty %}
                    {{ externalJudgement.result | printValidJuryResult }} by the external CCS
                {% else %}
                    <a href="{{ submission | externalCcsUrl }}" target="_blank">
                        {{ externalJudgement.result | printValidJuryResult }} by the external CCS
                    </a>
                {% endif -%}
                , but as
                {% if submission.importError %}
                    {{ 'import-error' | printValidJuryResult }}
                {% else %}
                    {{ selectedJudging.result | printValidJuryResult }}
                {% endif %}
                by DOMjudge.
            </p>

            {% include 'jury/partials/verify_form.html.twig' with {
                label: 'Shadow difference verified',
                judging: externalJudgement,
                form_action: path('jury_shadow_difference_verify', {extjudgementid: externalJudgement.extjudgementid}),
                show_form: true,
                show_icat: false} %}
        </div>
    {% endif %}

    {% if not sameTestcaseIds and selectedJudging is not null and selectedJudging.result is not empty %}
        <div class="alert alert-danger">The problem's testcases have changed since this judging has been performed. We recommend rejudging the whole problem.</div>
    {% endif %}

    {% if judgings | length > 1 or (judgings | length == 1 and selectedJudging is null) %}
        <h2>Judgings</h2>
        <table class="judging-table table table-striped table-hover table-sm" style="width: auto;">
            <thead>
            <tr>
                <td></td>
                <th scope="col">ID</th>
                <th scope="col">start</th>
                <th scope="col">max runtime</th>
                <th scope="col">judgehost</th>
                <th scope="col">result</th>
                <th scope="col">rejudging</th>
            </tr>
            </thead>
            <tbody>
            {% for judging in judgings %}
                {% set link = path('jury_submission', {submitId: submission.submitid, jid: judging.judgingid}) %}
                <tr {% if not judging.valid %}class="disabled"{% endif %}>
                    <td>
                        <a href="{{ link }}">
                            {% if selectedJudging is not null and selectedJudging.judgingid == judging.judgingid %}
                                <i class="fas fa-long-arrow-alt-right"></i>
                            {% else %}
                                &nbsp;
                            {% endif %}
                        </a>
                    </td>
                    <td><a href="{{ link }}">j{{ judging.judgingid }}</a></td>
                    <td><a href="{{ link }}">{{ judging.starttime | printtime(null, submission.contest) }}</a></td>
                    <td>
                        <a href="{{ link }}">
                            {% if maxRunTimes[judging.judgingId] is not null %}
                                {{ maxRunTimes[judging.judgingId] }}s
                            {% endif %}
                        </a>
                    </td>
                    <td>
                        <a href="{{ link }}">
                            {{ judging.judgehosts | printHosts }}
                        </a>
                    </td>
                    <td>
                        <a href="{{ link }}">
                            {{ judging.result | printResult(judging.valid, true) }}
                            {% if judging.stillBusy %}
                                (&hellip;)
                            {% endif %}
                        </a>
                    </td>
                    <td>
                        <a href="{{ link }}">
                            {% if judging.rejudging is not null %}
                                r{{ judging.rejudging.rejudgingid }} ({{ judging.rejudging.reason }})
                            {% endif %}
                        </a>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    {% endif %}

    {% if unjudgableReasons is not empty %}
        {% for reason in unjudgableReasons %}
            <div class="alert alert-danger">{{ reason }}</div>
        {% endfor %}
    {% endif %}

    {% if selectedJudging is not null or externalJudgement is not null %}

        {% if selectedJudging is not null %}

            {# Show judging information #}
            <div class="mb-2">
                <h3 style="display: inline;">
                    Judging j{{ selectedJudging.judgingid }}
                    {% if selectedJudging.rejudging %}
                        (rejudging
                        <a href="{{ path('jury_rejudging', {rejudgingId: selectedJudging.rejudging.rejudgingid}) }}">
                            r{{ selectedJudging.rejudging.rejudgingid }}</a>, reason: {{ selectedJudging.rejudging.reason }})
                    {% elseif not selectedJudging.valid %}
                        (Invalid)
                    {% endif %}

                    <span style="font-size: 70%; font-weight: normal;">
                        {% if not submission.importError %}
                            {% if selectedJudging is null or selectedJudging.result is empty %}
                                {%- if selectedJudging and selectedJudging.started %}
                                    {{- '' | printValidJuryResult -}}
                                {%- else %}
                                    {{- 'queued' | printValidJuryResult -}}
                                {%- endif %}
                            {%- else %}
                                {{- selectedJudging.result | printValidJuryResult -}}
                            {%- endif %}
                            {%- if submission.stillBusy -%}
                                (&hellip;)
                            {%- endif -%}
                        {% endif %}
                        {%- if lastJudging is not null -%}
                            {% set lastSubmissionLink = path('jury_submission', {submitId: lastSubmission.submitid}) %}{#-
                        -#}<span class="lastresult">
                            (<a href="{{ lastSubmissionLink }}">s{{ lastSubmission.submitid }}</a>: {{ lastJudging.result | printResult }}){#-
                        -#}</span>
                        {%- endif -%}
                        {%- if externalJudgement is not null %}
                            {% if submission.importError %}
                                External result: {{ externalJudgement.result | printValidJuryResult }}
                            {% else %}
                                (external: {{ externalJudgement.result | printValidJuryResult }})
                            {% endif %}
                        {%- endif %}
                        {%- if selectedJudging is not null and judgehosts is not empty -%}
                            , on {{ judgehosts | printHosts }}
                            {%- if selectedJudging.starttime -%}
                                {%- if selectedJudging.endtime -%}
                                    , took <span title="started: {{ selectedJudging.starttime | printtime('H:i:s') }}, completed: {{ selectedJudging.endtime | printtime('H:i:s') }}">{{ selectedJudging.starttime | printHumanTimeDiff(selectedJudging.endtime) }}</span>
                                {%- elseif selectedJudging.valid or selectedJudging.rejudging -%}
                                    &nbsp;[still judging - busy {{ selectedJudging.starttime | printtimediff }}]
                                {%- else -%}
                                    &nbsp;[aborted]
                                {%- endif -%}
                            {%- else -%}
                                , not started yet
                            {%- endif -%}
                        {%- endif -%}
                        {%- if externalJudgement is not null %}
                            <span class="judgetime">(external judging started: {{ externalJudgement.starttime | printtime('H:i:s') }}
                                {%- if externalJudgement.endtime -%}
                                    , finished in {{ externalJudgement.starttime | printtimediff(externalJudgement.endtime) }}s
                                {%- else -%}
                                    &nbsp;[still judging - busy {{ externalJudgement.starttime | printtimediff }}]
                                {%- endif -%}
                            )</span>
                        {%- endif -%}
                    </span>
                </h3>

                <div style="float: right;">
                    {% if selectedJudging.debugPackages | length > 0 %}
                       {% for debug_package in selectedJudging.debugPackages %}
                           <a href="{{ path('download_full_debug', {'debug_package_id': debug_package.debugPackageId }) }}">
                               <button class="btn btn-sm btn-outline-secondary" >
                                   <i class="fas fa-download"></i>
                                   Debug Package ({{ debug_package.judgehost.hostname }})
                               </button>
                           </a>
                       {% endfor %}
                    {% else %}
                        {% if not requestedOutputCount %}
                            <a href="{{ path('request_full_debug', {'jid': selectedJudging.judgingid}) }}">
                                <button class="btn btn-sm btn-outline-secondary" >
                                    <i class="fas fa-upload"></i>
                                    Retrieve Full Debug Package
                                </button>
                            </a>
                        {% endif %}
                    {% endif %}
                &nbsp;
                {% if not selectedJudging.verified %}
                    <form action="{{ path('jury_submission', {submitId: submission.submitid, jid: selectedJudging.judgingid}) }}"
                          method="post" style="display: inline;">
                        {% if selectedJudging.juryMember is not empty %}
                            (claimed by {{ selectedJudging.juryMember }})
                            <input type="hidden" name="forceclaim" value="1"/>
                        {% endif %}
                        {% if app.user.username == selectedJudging.juryMember %}
                            <input type="submit" value="unclaim" name="unclaim" class="btn btn-outline-secondary btn-sm"/>
                        {% else %}
                            <input type="submit" value="claim" name="claim" class="btn btn-outline-secondary btn-sm"/>
                        {% endif %}
                    </form>
                {% endif %}
                &nbsp;
                {% if selectedJudging is null or selectedJudging.result is empty %}
                    {%- if not selectedJudging or not selectedJudging.started %}
                        <a href="{{ path('jury_submission_create_tasks', {'submitId': submission.submitid}) }}">
                            <button class="btn btn-sm btn-outline-secondary" >
                                <i class="fas fa-gavel"></i>
                                Judge submission
                            </button>
                        </a>
                    {%- endif %}
                {%- endif %}
                </div>
            </div>
        {% endif %}

        {# Display compile output #}
        {% set color = '#6666FF' %}
        {% set message = 'not finished yet' %}
        {% set output = null %}
        {% if selectedJudging is not null %}
            {% set output = selectedJudging.outputCompile(true) %}
        {% endif %}
        {% if output is not null %}
            {% if selectedJudging.result == 'compiler-error' %}
                {% set message = 'unsuccessful' %}
            {% else %}
                {% set message = 'successful' %}
                {% if output is not empty %}
                    {% set outputLines = output | lineCount %}
                    {% if outputLines == 1 %}
                        {% set message = message ~ ' (with 1 line of output)' %}
                    {% else %}
                        {% set message = message ~ ' (with ' ~ outputLines ~ ' lines of output)' %}
                    {% endif %}
                {% endif %}
            {% endif %}
        {% endif %}
        Compilation <span class="compile-{{ message }}">{{ message }}</span>
        {% if selectedJudging is not null and selectedJudging.compileMetadata is not null %}
            {{ selectedJudging.compileMetadata | printMetadata }}
            <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse"
                    data-bs-target="#collapseExample-compilemeta"
                    aria-expanded="false">
                compilation metadata
            </button>
            <div class="collapse" id="collapseExample-compilemeta">
                <div class="card card-body output_text">{{ selectedJudging.compileMetadata }}</div>
            </div>
        {% endif %}
        {% if selectedJudging is not null and selectedJudging.result != 'compiler-error' %}
            <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse"
                    data-bs-target="#detailcompile"
                    aria-expanded="false">
                compilation output
            </button>
        {% endif %}
        <div class="card mb-3 {% if selectedJudging is null or selectedJudging.result != 'compiler-error' %}collapse{% endif%}"
             id="detailcompile">
            <div class="card-header">Compilation output</div>
            {% if output is empty %}
                <div class="card-body nodata">There were no compiler errors or warnings.</div>
            {% else %}
                <div class="card-body"><pre class="output_text">{{ output }}</pre></div>
            {% endif %}
        </div>

        <div class="mb-2">
            {# Display testcase results #}
            {% if externalJudgement is not null or (selectedJudging is not null and selectedJudging.result != 'compiler-error') %}
                <table>
                    {% if not submission.importError %}
                        <tr>
                            <td>
                                {% if selectedJudging is null %}
                                    {% set judgingDone = false %}
                                {% else %}
                                    {% set judgingDone = selectedJudging.endtime is not empty %}
                                {% endif %}
                                {{ runs | displayTestcaseResults(judgingDone) }}
                            </td>
                            <td>
                                {% if selectedJudging is not null and runsOutstanding %}
                                    {% if selectedJudging.judgeCompletely %}
                                        <i class="fas fa-balance-scale" title="remaining test cases requested to be judged"></i>
                                    {% elseif selectedJudging.result is not null %}
                                        <form action="{{ path('jury_submission_request_remaining', {'judgingId': selectedJudging.judgingid}) }}" method="post"
                                              style="display: inline; ">
                                            <button type="submit" class="btn btn-outline-secondary btn-sm" style="padding: 0.1rem 0.5rem; font-size: 0.7em"><i class="fa-solid fa-gavel"></i> judge remaining</button>
                                        </form>
                                    {% endif %}
                                {% endif %}
                            </td>
                        </tr>
                    {% endif %}
                    {% if externalJudgement is not null %}
                        <tr>
                            <td>
                                {{ externalRuns | displayTestcaseResults(externalJudgement.endtime is not empty, true) }}
                            </td>
                            <td>
                                {% if externalSubmissionUrl and externalSubmissionUrl is not empty %}
                                <a href="{{ externalSubmissionUrl }}">
                                    {% endif %}
                                    external {{ externalJudgement.extjudgementid }}
                                    {% if externalSubmissionUrl and externalSubmissionUrl is not empty %}
                                </a>
                                {% endif %}
                            </td>
                        </tr>
                    {% endif %}
                    {% if lastJudging is not null %}
                        <tr class="lasttcruns">
                            <td>
                                {{ lastRuns | displayTestcaseResults(lastJudging.endtime is not empty) }}
                            </td>
                            <td>
                                <a href="{{ lastSubmissionLink }}">previous s{{ lastSubmission.submitid }}</a>
                                {% if lastJudging.verifyComment %}
                                    <span class="prevsubmit">(verify comment: '{{ lastJudging.verifyComment }}')</span>
                                {% endif %}
                            </td>
                        </tr>
                    {% endif %}
                </table>

            {% endif %}
        </div>

        {# Show verify info, but only when a result is known #}
        {% if selectedJudging is not null and selectedJudging.result is not empty %}
            {% include 'jury/partials/verify_form.html.twig' with {
                label: 'Verified',
                judging: selectedJudging,
                form_action: path('jury_judging_verify', {judgingId: selectedJudging.judgingid}),
                show_form: not (verificationRequired and selectedJudging.verified and selectedJudging.valid),
                show_icat: true} %}
            {% if submission.contestProblem and icat_url %}
                <script>
                    $(function () {
                        $('#post-to-icat').on('click', function () {
                            postVerifyCommentToICAT(
                                '{{ icat_url }}/insert_entry.php',
                                '{{ app.user.username }}',
                                '{{ submission.team.teamid }}',
                                '{{ submission.contestProblem.shortname }}',
                                '{{ submission.externalid }}'
                            );
                            alert('Comment posted to iCAT.');
                            return false;
                        });
                    });
                </script>
            {% endif %}
        {% elseif selectedJudging is not null %}
            <div class="alert alert-warning">Judging is not ready yet!</div>
        {% endif %}

        {% if (selectedJudging is not null and selectedJudging.result != 'compiler-error')
            or (externalJudgement is not null and externalJudgement.result != 'compiler-error') %}
            {% include 'jury/partials/submission_graph.html.twig' %}
        {% endif %}

        <hr>
        <br>

        {% if externalJudgement is not null or (selectedJudging is not null and selectedJudging.result != 'compiler-error') %}
            {# Show run info. Only when compilation was successful or we have an external judgement #}
            {% for runIdx, run in runs %}
                {% set externalRun = null %}
                {% if externalRuns[runIdx] is defined %}
                    {% set externalRun = externalRuns[runIdx] %}
                {% endif %}
                <div id="run-{{run.rank}}"
                     style="margin-bottom: 20px;"
                     class="card run {% if run.firstJudgingRun and run.firstJudgingRun.runresult == 'correct' %}run_correct{% endif %}">
                    <div class="card-header">
                        Run #{{ run.rank }}
                        {% if run.origInputFilename is not null %}
                            | <span class="filename">{{ run.origInputFilename }}.in</span>
                        {% else %}
                            {% if run.description is not null %}
                                | {{ run.description(true) }}
                            {% endif %}
                        {% endif %}
                        {% if run.firstJudgingRun is not null %}
                            |
                            {% if run.firstJudgingRun.runresult is not null %}
                                <span class="sol {% if run.firstJudgingRun.runresult == 'correct' %}sol_correct{% else %}sol_incorrect{% endif %}">
                                    {{ run.firstJudgingRun.runresult }}
                                </span>
                                {% if run.firstJudgingRun.runresult == 'timelimit' %}
                                    {% if runsOutput[runIdx].terminated %}
                                        <b>(terminated)</b>
                                    {% else %}
                                        <b>(finished late)</b>
                                    {% endif %}
                                {% endif %}
                            {% else %}
                                <span class="sol sol_queued">
                                   {% if runsOutput[runIdx].hostname is null %}
                                       queued
                                   {% else %}
                                       judging
                                   {% endif %}
                                </span>
                            {% endif %}
                        {% endif %}
                        {% if runsOutput[runIdx].hostname is not null %}
                            {% set judgehostLink = path('jury_judgehost', {judgehostid: runsOutput[runIdx].judgehostid}) %}
                            | <a href="{{ judgehostLink }}">{{ runsOutput[runIdx].hostname | printHost }}</a>
                        {% endif %}
                        {% if externalRun is not null and externalRun.firstExternalRun is not null %}
                            {% if externalRun.firstExternalRun is not null %}
                                (external:
                                <span class="sol {% if externalRun.firstExternalRun.result == 'correct' %}sol_correct{% else %}sol_incorrect{% endif %}">
                                    {{ externalRun.firstExternalRun.result }}{#-
                                -#}</span>{#-
                                -#})
                            {% endif %}
                        {% endif %}
                        {% if runsOutput[runIdx].testcasedir is defined and runsOutput[runIdx].testcasedir is not null %}
                          | <code>.../{{ runsOutput[runIdx].testcasedir | split('/') | last }}</code>{#-
                            -#}<button type="button" class="btn btn-link" onclick="navigator.clipboard.writeText('{{ runsOutput[runIdx].testcasedir }}')"><i class="fa-regular fa-copy"></i></button>
                        {% endif %}
                        <div style="float: right;">
                            <a href="{{ path('jury_problem_testcase_fetch', {'probId': submission.problem.probid, 'rank': run.rank, 'type': 'input'}) }}">
                                <button class="btn btn-sm btn-outline-secondary" >
                                    <i class="fas fa-download"></i>
                                    Input
                                </button>
                            </a>
                            <a href="{{ path('jury_problem_testcase_fetch', {'probId': submission.problem.probid, 'rank': run.rank, 'type': 'output'}) }}">
                                <button class="btn btn-sm btn-outline-secondary" >
                                    <i class="fas fa-download"></i>
                                    Reference Output
                                </button>
                            </a>
                            {% if run.firstJudgingRun is not null %}
                                <a href="{{ path('jury_submission_team_output', {'submission': submission.submitid, 'run': run.firstJudgingRun.runid, 'contest': submission.contest.cid}) }}">
                                    <button class="btn btn-sm btn-outline-secondary" >
                                        <i class="fas fa-download"></i>
                                        {% if runsOutput[runIdx].is_output_run_truncated_in_db %}
                                            Truncated
                                        {% endif %}
                                        Team Output
                                    </button>
                                </a>
                                {% if runsOutput[runIdx].is_output_run_truncated_in_db %}
                                    <a href="{{ path('request_output', {'jid': run.firstJudgingRun.judgingid, 'jrid': run.firstJudgingRun.runid}) }}">
                                        <button class="btn btn-sm btn-outline-secondary" >
                                            <i class="fas fa-upload"></i>
                                            Retrieve Full Team Output
                                        </button>
                                    </a>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-body">
                    {% if run.firstJudgingRun is not null %}
                        {% if run.firstJudgingRun.runresult != 'correct' and isMultiPassProblem %}
                            <div class="alert alert-warning">Note that this is a multi-pass problem, and only data of the failing pass is presented.</div>
                        {% endif %}
                        {{ runsOutput[runIdx].metadata | printMetadata }}
                        <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse"
                                data-bs-target="#collapseExample-{{ runIdx }}"
                                aria-expanded="false">
                            show complete metadata
                        </button>
                        {% if runsOutput[runIdx].metadata is not null %}
                            {% if runsOutput[runIdx].output_limit %}
                                <div class="alert alert-warning">
                                    The submission output (<code>{{ runsOutput[runIdx].output_limit }}</code>) was
                                    truncated because of the configured output limit.
                                </div>
                            {% endif %}
                            <div class="collapse" id="collapseExample-{{ runIdx }}">
                                  <div class="card card-body output_text">{{ runsOutput[runIdx].metadata }}</div>
                            </div>
                        {% endif %}
                    </span>
                    {% endif %}
                    {% if run.description is not null %}
                        <p><em>
                            {{ run.description(true) | descriptionExpand }}
                        </em></p>
                    {% endif %}
                    {% if runsOutput[runIdx].image_thumb %}
                        <span style="float:right; border: 3px solid #438ec3; margin: 5px; padding: 5px;">
                            {% set imgUrl = path('jury_problem_testcase_fetch', {'probId': submission.problem.probid, 'rank': run.rank, 'type': 'image'}) %}
                            <a href="{{ imgUrl }}">
                                <img src="data:image/{{ run.imageType }};base64,{{ runsOutput[runIdx].image_thumb | base64 }}"/>
                            </a>
                        </span>
                    {% endif %}

                    {% set runDone = false %}
                    {% if run is not null and run.firstJudgingRun is not null and run.firstJudgingRun.runresult is not null %}
                        {% set runDone = true %}
                    {% endif %}
                    {% if not runDone %}
                        <p class="nodata">
                            {% if selectedJudging is not null and selectedJudging.result %}
                                Run not used for final result.
                            {% else %}
                                Run not started/finished yet.
                            {% endif %}
                        </p>
                    {% else %}
                        {% if run.firstJudgingRun is not null and run.firstJudgingRun.runresult is not null %}
                            {% if combinedRunCompare %}
                                <h5>Validator output</h5>
                                {% if runsOutput[runIdx].output_diff is empty %}
                                    <p class="nodata">There was no validator output.</p>
                                {% else %}
                                    <pre class="output_text">{{ runsOutput[runIdx].output_diff }}</pre>
                                {% endif %}
                            {% else %}
                                <h5>Diff output</h5>
                                {% if runsOutput[runIdx].output_diff is empty %}
                                    <p class="nodata">There was no diff output.</p>
                                {% else %}
                                    <pre class="output_text">{{ runsOutput[runIdx].output_diff }}</pre>
                                {% endif %}

                                {% if run.firstJudgingRun.runresult != 'correct' %}
                                    {{ runsOutput[runIdx] | runDiff }}
                                {% endif %}
                            {% endif %}

                            {% if combinedRunCompare %}
                                <h5>Validator/Submission interaction</h5>
                                {% if runsOutput[runIdx].output_run is empty %}
                                    <p class="nodata">There was no interaction log.</p>
                                {% else %}
                                    {{ runsOutput[runIdx].output_run | interactiveLog }}
                                {% endif %}
                            {% else %}
                                <h5>Program output</h5>
                                {% if runsOutput[runIdx].output_run is empty %}
                                    <p class="nodata">There was no program output.</p>
                                {% else %}
                                    <pre class="output_text">{{ runsOutput[runIdx].output_run }}</pre>
                                {% endif %}
                            {% endif %}

                            <h5>Program error output</h5>
                            {% if runsOutput[runIdx].output_error is empty %}
                                <p class="nodata">There was no stderr output.</p>
                            {% else %}
                                <pre class="output_text">{{ runsOutput[runIdx].output_error }}</pre>
                            {% endif %}

                            <h5>Judging system output (info/debug/errors)</h5>
                            {% if runsOutput[runIdx].output_system is empty %}
                                <p class="nodata">There was no judging system output.</p>
                            {% else %}
                                <pre class="output_text">{{ runsOutput[runIdx].output_system }}</pre>
                            {% endif %}

                            {% if runsOutput[runIdx].team_message is not empty %}
                                <h5>Judge message for the team</h5>
                                <pre class="output_text">
{{  runsOutput[runIdx].team_message }}</pre>
                            {%  endif %}
                        {% endif %}
                    {% endif %}

                    </div>
                </div>
            {% endfor %}

            <script>
                function display_correctruns(show) {
                    elements = document.getElementsByClassName('run_correct');
                    for (var i = 0; i < elements.length; i++) {
                        elements[i].style.display = show ? 'block' : 'none';
                    }
                }

                display_correctruns(false);
            </script>
        {% endif %} {# selectedJudging.result != 'compiler-error' #}

    {% endif %} {# selectedJudging is not null or externalJudgement is not null #}

{% endblock %}
