{# @var \App\Entity\ExternalJudgement externalJudgement #}
{% extends "jury/base.html.twig" %}

{% block title %}Submission {{ submission.externalid }} - {{ parent() }}{% endblock %}

{% block extrahead %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/nv.d3.min.css') }}">
    <script src="{{ asset('js/d3.min.js') }}"></script>
    <script src="{{ asset('js/nv.d3.min.js') }}"></script>
    <script src="{{ asset('js/FileSaver.min.js') }}"></script>
    <style>
        .judging-table td a, .judging-table td a:hover {
            display: block;
            text-decoration: none;
            color: inherit;
        }

        .judging-table tr.disabled td a {
            color: silver
        }

        .image_thumb {
            max-width: {{ thumbnailSize }}px;
            max-height: {{ thumbnailSize }}px;
        }
    </style>
{% endblock %}

{% block content %}

    {% macro render_scoring_group(group, depth) %}
        <div class="scoring-group mb-1 {{ depth > 0 ? 'scoring-group-indent' : 'scoring-group-root' }}">
            <div class="scoring-group-header mb-1 d-flex align-items-center flex-wrap">
                <i class="fas {{ depth == 0 ? 'fa-sitemap' : 'fa-folder-open' }} me-2 text-muted"></i>
                <strong title="{{ group.name }}">{{ group.display_name }}</strong>
                <span class="badge ms-2 scoring-agg-pill scoring-agg-{{ group.aggregation }}">{{ group.aggregation | upper }}</span>
                {% if group.accept_score is not null %}
                    <span class="badge badge-info ms-2 scoring-accept-pill">Accept score: {{ group.accept_score }}</span>
                {% endif %}
            </div>
            <div class="text-muted mb-1 scoring-info">
                <div class="d-flex align-items-center flex-wrap">
                    <span class="badge text-bg-{{ group.result == 'correct' ? 'success' : 'danger' }} badge-testcase me-2">
                        {{ group.result == 'correct' ? 'âœ“' : (group.result ? group.result|slice(0,1) : '?') }}
                    </span>
                    <span class="text-dark">
                        <strong title="{{ group.score is not null ? 'Full score: ' ~ group.score : '' }}">
                            {% if group.score is not null %}
                                <span class="rounded-precision">{{ "%.2f" | format(group.score) }}</span>
                                <span class="full-precision">{{ group.score }}</span>
                            {% else %}
                                ?
                            {% endif %}
                        </strong>
                        {% if group.child_scores is not empty and (group.child_scores | length > 1 or group.child_scores[0] != group.score) %}
                            <span class="text-muted ms-1 scoring-equation">
                                =
                                {% if group.aggregation == 'avg' or group.aggregation == 'min' or group.aggregation == 'max' -%}
                                    {{ group.aggregation == 'avg' ? '(' : group.aggregation ~ '(' -}}
                                {%- endif %}
                                {%- for s in group.child_scores -%}
                                    <span class="rounded-precision">{{ "%.2f" | format(s) }}</span>
                                    <span class="full-precision">{{ s }}</span>
                                    {{- not loop.last ? (group.aggregation == 'min' or group.aggregation == 'max' ? ', ' : ' + ') : '' -}}
                                {%- endfor %}
                                {%- if group.aggregation == 'avg' %}) / {{ group.child_scores | length }}{% elseif group.aggregation == 'min' or group.aggregation == 'max' %}){% endif %}
                            </span>
                        {% endif %}
                    </span>
                </div>
            </div>

            <div>
                {% if group.children is not empty %}
                    <div>
                        {% for child in group.children %}
                            {{ _self.render_scoring_group(child, depth + 1) }}
                        {% endfor %}
                    </div>
                {% elseif group.testcases is not empty %}
                    <div class="ms-2">
                        <ul class="list-unstyled mb-0 scoring-testcase-list">
                            {% for tc in group.testcases %}
                                <li class="d-flex align-items-center mb-0">
                                    <i class="far fa-file me-1 text-muted scoring-testcase-icon"></i>
                                    <span class="scoring-testcase-name">
                                        <a href="#run-{{ tc.rank }}" title="{{ tc.orig_input_filename }}">
                                            {% if tc.display_name is not empty %}
                                                {{ tc.display_name }}
                                            {% else %}
                                                #{{ tc.rank }}
                                            {% endif %}
                                        </a>
                                    </span>
                                    <span class="ms-1 scoring-testcase-result">
                                        {{ tc.result | displayScoringTestcaseResult(tc.rank) }}
                                    </span>
                                    {% if group.accept_score is null %}
                                        <span class="ms-1 scoring-testcase-score text-muted" title="{{ tc.score is not null ? 'Full score: ' ~ tc.score : '' }}">
                                            {% if tc.score is not null %}
                                                <span class="rounded-precision">{{ "%.2f" | format(tc.score) }}</span>
                                                <span class="full-precision">{{ tc.score }}</span>
                                            {% else %}
                                                -
                                            {% endif %}
                                        </span>
                                    {% endif %}
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}
            </div>
        </div>
    {% endmacro %}

    {% if submission.externalJudgements.empty %}
        {% set externalJudgement = null %}
    {% else %}
        {% set externalJudgement = submission.externalJudgements.first %}
    {% endif %}

    {% if claimWarning %}
        <div class="alert alert-warning">
            {{ claimWarning }}
        </div>
    {% endif %}

    {% if requestedOutputCount %}
        <div class="alert alert-warning">
            Waiting for {{ requestedOutputCount }} team output(s) (or full debug package) to be grabbed and uploaded.
        </div>
    {% endif %}

    {% if selectedJudging is not null and selectedJudging.result is not empty and submission.expectedScore is not null %}
        {# Expected score comparison for scoring problems #}
        {% if selectedJudging.score == submission.expectedScore %}
            <div class="alert alert-success">
                Actual score matches the expected score ({{ selectedJudging.score }}).
            </div>
        {% else %}
            <div class="alert alert-danger">
                Actual score {{ selectedJudging.score }} does NOT match expected score: {{ submission.expectedScore }}.
            </div>
        {% endif %}
    {% elseif selectedJudging is not null and selectedJudging.result is not empty and submission.expectedResults %}
        {# Expected verdict comparison for pass/fail problems #}
        {% if selectedJudging.result|upper not in submission.expectedResults %}
            <div class="alert alert-danger">
                Actual result {{ selectedJudging.result | printValidJuryResult }} does NOT match expected result(s):
                {% for expectedResult in submission.expectedResults %}
                    {{ expectedResult | printValidJuryResult }}
                    {% if not loop.last %}or{% endif %}
                {% endfor %}.
            </div>
        {% elseif submission.expectedResults|length > 1 %}
            <div class="alert alert-warning">
                Actual result {{ selectedJudging.result | printValidJuryResult }} matches one of multiple expected results:
                {% for expectedResult in submission.expectedResults %}
                    {{ expectedResult | printValidJuryResult }}
                    {% if not loop.last %}or{% endif %}
                {% endfor %}.
            </div>
        {% else %}
            <div class="alert alert-success">
                Actual result matches the expected result ({{ selectedJudging.result | printValidJuryResult }}).
            </div>
        {% endif %}
    {% endif %}

    {% if version_warnings is not null and version_warnings is not empty %}
        {% for type, versions in version_warnings %}
            <div class="alert alert-warning">
                <p>
                    This judging did not use the same {{ type }} version for all testcases.
                    This may lead to unexpected results. Versions used:
                </p>
                <p>
                    {% for version in versions %}
                            <pre class="output_text">{{ version }}</pre>
                            {% if not loop.last %}<hr />{% endif %}
                    {% endfor %}
                </p>
            </div>
        {% endfor %}
    {% endif %}

    <div class="card">
        <div class="card-header">
            <h1 style="display: inline;">
                Submission {{ submission.externalid }}
                {% if submission.originalSubmission %}
                    {% set origSubmissionUrl = path('jury_submission', {submitId: submission.originalSubmission.externalid}) %}
                    (resubmit of <a href="{{ origSubmissionUrl }}">{{ submission.originalSubmission.externalid }}</a>)
                {% endif %}
                {% if submission.resubmissions is not empty %}
                    (resubmitted as
                    {%- for resubmission in submission.resubmissions -%}
                        {% set resubmissionUrl = path('jury_submission', {submitId: resubmission.externalid}) %}
                        <a href="{{ resubmissionUrl }}">{{ resubmission.externalid }}</a>
                        {%- if not loop.last -%},{%- endif -%}
                    {%- endfor -%}
                    )
                {% endif %}
                {% if not submission.valid %}
                    (ignored)
                {% endif %}
            </h1>
            {% if not submission.importError %}
                <div style="float: right;">
                    {% if is_granted('ROLE_ADMIN') %}
                        {% if submission.valid %}
                            {% set action = 'ignore' %}
                        {% else %}
                            {% set action = 'unignore' %}
                        {% endif %}
                        <form action="{{ path('jury_submission_update_status', {'submitId': submission.externalid}) }}" method="post"
                              style="display: inline; ">
                            <input type="hidden" name="valid" value="{% if submission.valid %}0{% else %}1{% endif %}"/>
                            <input type="submit" class="btn btn-outline-secondary btn-sm"
                                   value="{{ action | upper }} this submission"
                                   onclick="return confirm('Really {{ action }} submission {{ submission.externalid }}?');"/>
                        </form>
                    {% endif %}

                    {% include 'jury/partials/rejudge_form.html.twig' with {table: 'submission', id: submission.externalid} %}
                </div>
            {% endif %}

            {# Condensed submission info on a single line with icons #}
            <div class="submission-summary mb-2">
                <span>
                    <i class="fas fa-users" title="Team:"></i>
                    <a href="{{ path('jury_team', {teamId: submission.team.externalid, cid: submission.contest.externalid}) }}">
                        {{ submission.team.effectiveName }} {{ submission.team | entityIdBadge }}
                    </a>
                </span>

                {% if submission.user %}
                    <span>
                        <i class="fas fa-user" title="User:"></i>
                        <a href="{{ path('jury_user', {userId: submission.user.externalid, cid: submission.contest.externalid}) }}">
                            {{ submission.user.username }} {{ submission.user | entityIdBadge }}
                        </a>
                    </span>
                {% endif %}

                {% if current_contest.cid != submission.contest.cid %}
                    <span>
                        <i class="fas fa-trophy" title="Contest:"></i>
                        <a href="{{ path('jury_contest', {'contestId': submission.contest.externalid}) }}">
                            {{ submission.contest.shortname }}
                            {{ submission.contest | entityIdBadge }}
                        </a>
                    </span>
                {% endif %}

                <span>
                    <i class="fas fa-book-open" title="Problem:"></i>
                    <a href="{{ path('jury_problem', {'probId': submission.problem.externalid}) }}">
                        {% if submission.contestProblem %}
                            {{ submission.contestProblem | problemBadge }} {{ submission.problem.name }}
                        {% else %}
                            {{ submission.problem.name }}
                        {% endif %}
                        {{ submission.problem | entityIdBadge }}
                    </a>
                </span>

                <span>
                    <i class="fas fa-comments" title="Language:"></i>
                    <a href="{{ path('jury_language', {'langId': submission.language.externalid}) }}">
                        {{ submission.language.name }}
                        {{ submission.language | entityIdBadge }}
                    </a>
                </span>

                <span>
                    <i class="fas fa-clock" title="Submittime:"></i>
                    <span title="{{ submission.submittime | printtime('Y-m-d H:i:s (T)') }}">
                        {{ submission.submittime | printtime(null, submission.contest) }}
                    </span>
                </span>

                <span>
                    <i class="fas fa-stopwatch" title="Allowed runtime:"></i>
                    {{ submission.problem.timelimit * submission.language.timeFactor }}s
                </span>

                <span>
                    <i class="fas fa-code" title="Source code:"></i>
                    <a href="{{ path('jury_submission_source', {submission: submission.externalid}) }}">
                        View {{ submission.files | printFiles }}
                    </a>
                </span>

                {% if shadowMode() and external_ccs_submission_url is not empty %}
                    {% set externalSubmissionUrl = submission | externalCcsUrl %}
                    {% if externalSubmissionUrl is not empty %}
                        <span>
                            <i class="fas fa-link" title="External link:"></i>
                            <a href="{{ externalSubmissionUrl }}" target="_blank">
                                View in external CCS
                            </a>
                        </span>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
    <br />

    {% if not submission.valid %}
        <div class="alert alert-danger">This submission is not used during scoreboard calculations.</div>
    {% endif %}

    {% if submission.importError %}
        <div class="alert alert-danger">
            <div>This submission could not be imported into DOMjudge and thus will only show external data.</div>
            <div>The error during import was: <code>{{ submission.importError }}</code></div>
        </div>
    {% endif %}

    {% if not submission.contestProblem %}
        <div class="alert alert-danger">
            This submission is for a problem that is not part (anymore) of the contest of the submission.
        </div>
    {% endif %}

    {% if externalJudgement is not null and externalJudgement.result is not empty and (
        (selectedJudging is not null and selectedJudging.result is not empty and externalJudgement.result != selectedJudging.result)
        or submission.importError) %}
        <div class="alert alert-danger">
            <strong>Results differ!</strong>
            <hr>
            <p>
                This submission was judged as
                {% if external_ccs_submission_url is empty %}
                    {{ externalJudgement.result | printValidJuryResult }} by the external CCS
                {% else %}
                    <a href="{{ submission | externalCcsUrl }}" target="_blank">
                        {{ externalJudgement.result | printValidJuryResult }} by the external CCS
                    </a>
                {% endif -%}
                , but as
                {% if submission.importError %}
                    {{ 'import-error' | printValidJuryResult }}
                {% else %}
                    {{ selectedJudging.result | printValidJuryResult }}
                {% endif %}
                by DOMjudge.
            </p>

            {% include 'jury/partials/verify_form.html.twig' with {
                label: 'Shadow difference verified',
                judging: externalJudgement,
                form_action: path('jury_shadow_difference_verify', {extjudgementid: externalJudgement.extjudgementid}),
                show_form: true,
                show_icat: false} %}
        </div>
    {% endif %}

    {% if not sameTestcaseHashes and selectedJudging is not null and selectedJudging.result is not empty %}
        <div class="alert alert-danger">The problem's testcases have changed since this judging has been performed. We recommend rejudging the whole problem.</div>
    {% endif %}

    {% if judgings | length > 1 or (judgings | length == 1 and selectedJudging is null) %}
        <h2>Judgings</h2>
        <table class="judging-table table table-striped table-hover table-sm" style="width: auto;">
            <thead>
            <tr>
                <td></td>
                <th scope="col">ID</th>
                <th scope="col">start</th>
                <th scope="col">max runtime</th>
                <th scope="col">judgehost</th>
                <th scope="col">result</th>
                {% if submission.problem.scoringProblem %}
                    <th scope="col">score</th>
                {% endif %}
                <th scope="col">rejudging</th>
            </tr>
            </thead>
            <tbody>
            {% for judging in judgings %}
                {% set link = path('jury_submission', {submitId: submission.externalid, jid: judging.judgingid}) %}
                <tr {% if not judging.valid %}class="disabled"{% endif %}>
                    <td>
                        <a href="{{ link }}">
                            {% if selectedJudging is not null and selectedJudging.judgingid == judging.judgingid %}
                                <i class="fas fa-long-arrow-alt-right"></i>
                            {% else %}
                                &nbsp;
                            {% endif %}
                        </a>
                    </td>
                    <td><a href="{{ link }}">j{{ judging.judgingid }}</a></td>
                    <td><a href="{{ link }}">{{ judging.starttime | printtime(null, submission.contest) }}</a></td>
                    <td>
                        <a href="{{ link }}">
                            {% if maxRunTimes[judging.judgingId] is not null %}
                                {{ maxRunTimes[judging.judgingId] }}s
                            {% endif %}
                        </a>
                    </td>
                    <td>
                        <a href="{{ link }}">
                            {{ judging.judgehosts | printHosts }}
                        </a>
                    </td>
                    <td>
                        <a href="{{ link }}">
                            {{ judging.result | printResult(judging.valid, true) }}
                            {% if judging.stillBusy %}
                                (&hellip;)
                            {% endif %}
                        </a>
                    </td>
                    {% if submission.problem.scoringProblem %}
                        <td class="right">
                            <a href="{{ link }}">
                                {% if judging.score is not null %}
                                    {{ "%.2f" | format(judging.score) }}
                                {% else %}
                                    -
                                {% endif %}
                            </a>
                        </td>
                    {% endif %}
                    <td>
                        <a href="{{ link }}">
                            {% if judging.rejudging is not null %}
                                r{{ judging.rejudging.rejudgingid }} ({{ judging.rejudging.reason }})
                            {% endif %}
                        </a>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    {% endif %}

    {% if unjudgableReasons is not empty %}
        {% for reason in unjudgableReasons %}
            <div class="alert alert-danger">{{ reason }}</div>
        {% endfor %}
    {% endif %}

    {% if selectedJudging is not null or externalJudgement is not null %}

        {% if selectedJudging is not null %}

            {# Show judging information #}
            <div class="mb-2">
                <h3 style="display: inline;">
                    Judging j{{ selectedJudging.judgingid }}
                    {% if selectedJudging.rejudging %}
                        (rejudging
                        <a href="{{ path('jury_rejudging', {rejudgingId: selectedJudging.rejudging.rejudgingid}) }}">
                            r{{ selectedJudging.rejudging.rejudgingid }}</a>, reason: {{ selectedJudging.rejudging.reason }})
                    {% elseif not selectedJudging.valid %}
                        (Invalid)
                    {% endif %}

                    <span style="font-size: 70%; font-weight: normal;">
                        {% if not submission.importError %}
                            {% if selectedJudging is null or selectedJudging.result is empty %}
                                {%- if selectedJudging and selectedJudging.started %}
                                    {{- '' | printValidJuryResult -}}
                                {%- else %}
                                    {{- 'queued' | printValidJuryResult -}}
                                {%- endif %}
                            {%- else %}
                                {{- selectedJudging.result | printValidJuryResult -}}
                            {%- endif %}
                            {% if submission.problem.scoringProblem %}
                                (score: <span title="{{ selectedJudging.score }}">{{ "%.2f" | format(selectedJudging.score) }}</span>)
                            {% endif %}
                            {%- if submission.stillBusy -%}
                                (&hellip;)
                            {%- endif -%}
                        {% endif %}
                        {%- if lastJudging is not null -%}
                            {% set lastSubmissionLink = path('jury_submission', {submitId: lastSubmission.externalid}) %}{#-
                        -#}<span class="lastresult">
                            (<a href="{{ lastSubmissionLink }}">{{ lastSubmission.externalid }}</a>: {{ lastJudging.result | printResult }}){#-
                        -#}</span>
                        {%- endif -%}
                        {%- if externalJudgement is not null %}
                            {% if submission.importError %}
                                External result: {{ externalJudgement.result | printValidJuryResult }}
                            {% else %}
                                (external: {{ externalJudgement.result | printValidJuryResult }}
                                {% if submission.problem.scoringProblem %}
                                    , score: {{ "%.2f" | format(externalJudgement.score) }}
                                {% endif %}
                                )
                            {% endif %}
                        {%- endif %}
                        {%- if selectedJudging is not null and judgehosts is not empty -%}
                            , on {{ judgehosts | printHosts }}
                            {%- if selectedJudging.starttime -%}
                                {%- if selectedJudging.endtime -%}
                                    , started at <span title="{{ selectedJudging.starttime | printtime('Y-m-d H:i:s (T)') }}">{{ selectedJudging.starttime | printtime('H:i') }}</span>
                                    , took <span title="completed: {{ selectedJudging.endtime | printtime('Y-m-d H:i:s (T)') }}">{{ selectedJudging.starttime | printHumanTimeDiff(selectedJudging.endtime) }}</span>
                                {%- elseif selectedJudging.valid or selectedJudging.rejudging -%}
                                    &nbsp;[still judging - busy {{ selectedJudging.starttime | printtimediff }}]
                                {%- else -%}
                                    &nbsp;[aborted]
                                {%- endif -%}
                            {%- else -%}
                                , not started yet
                            {%- endif -%}
                        {%- endif -%}
                        {%- if externalJudgement is not null %}
                            <span class="judgetime">(external judging started: {{ externalJudgement.starttime | printtime('H:i:s') }}
                                {%- if externalJudgement.endtime -%}
                                    , finished in {{ externalJudgement.starttime | printtimediff(externalJudgement.endtime) }}s
                                {%- else -%}
                                    &nbsp;[still judging - busy {{ externalJudgement.starttime | printtimediff }}]
                                {%- endif -%}
                            )</span>
                        {%- endif -%}
                    </span>
                </h3>

                <div style="float: right;">
                    {% if selectedJudging.debugPackages | length > 0 %}
                       {% for debug_package in selectedJudging.debugPackages %}
                           <a href="{{ path('download_full_debug', {'debug_package_id': debug_package.debugPackageId }) }}">
                               <button class="btn btn-sm btn-outline-secondary" >
                                   <i class="fas fa-download"></i>
                                   Debug Package ({{ debug_package.judgehost.hostname }})
                               </button>
                           </a>
                       {% endfor %}
                    {% else %}
                        {% if not requestedOutputCount %}
                            <a href="{{ path('request_full_debug', {'jid': selectedJudging.judgingid}) }}">
                                <button class="btn btn-sm btn-outline-secondary" >
                                    <i class="fas fa-upload"></i>
                                    Retrieve Full Debug Package
                                </button>
                            </a>
                        {% endif %}
                    {% endif %}
                &nbsp;
                {% if not selectedJudging.verified %}
                    <form action="{{ path('jury_submission', {submitId: submission.externalid, jid: selectedJudging.judgingid}) }}"
                          method="post" style="display: inline;">
                        {% if selectedJudging.juryMember is not empty %}
                            (claimed by {{ selectedJudging.juryMember }})
                            <input type="hidden" name="forceclaim" value="1"/>
                        {% endif %}
                        {% if app.user.username == selectedJudging.juryMember %}
                            <input type="submit" value="unclaim" name="unclaim" class="btn btn-outline-secondary btn-sm"/>
                        {% else %}
                            <input type="submit" value="claim" name="claim" class="btn btn-outline-secondary btn-sm"/>
                        {% endif %}
                    </form>
                {% endif %}
                &nbsp;
                {% if selectedJudging is null or selectedJudging.result is empty %}
                    {%- if not selectedJudging or not selectedJudging.started %}
                        <a href="{{ path('jury_submission_create_tasks', {'submitId': submission.externalid}) }}">
                            <button class="btn btn-sm btn-outline-secondary" >
                                <i class="fas fa-gavel"></i>
                                Judge submission
                            </button>
                        </a>
                    {%- endif %}
                {%- endif %}
                </div>
            </div>
        {% endif %}

        {# Display compile output #}
        {% set color = '#6666FF' %}
        {% set message = 'not finished yet' %}
        {% set output = null %}
        {% if selectedJudging is not null %}
            {% set output = selectedJudging.outputCompile(true) %}
        {% endif %}
        {% if output is not null %}
            {% if selectedJudging.result == 'compiler-error' %}
                {% set message = 'unsuccessful' %}
            {% else %}
                {% set message = 'successful' %}
                {% if output is not empty %}
                    {% set outputLines = output | lineCount %}
                    {% if outputLines == 1 %}
                        {% set message = message ~ ' (with 1 line of output)' %}
                    {% else %}
                        {% set message = message ~ ' (with ' ~ outputLines ~ ' lines of output)' %}
                    {% endif %}
                {% endif %}
            {% endif %}
        {% endif %}
        Compilation <span class="compile-{{ message }}">{{ message }}</span>
        {% if selectedJudging is not null and selectedJudging.compileMetadata is not null %}
            {{ selectedJudging.compileMetadata | printMetadata }}
            <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse"
                    data-bs-target="#collapseExample-compilemeta"
                    aria-expanded="false">
                compilation metadata
            </button>
            <div class="collapse" id="collapseExample-compilemeta">
                <div class="card card-body output_text">{{ selectedJudging.compileMetadata }}</div>
            </div>
        {% endif %}
        {% if output and selectedJudging is not null and selectedJudging.result != 'compiler-error' %}
            <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse"
                    data-bs-target="#detailcompile"
                    aria-expanded="false">
                compilation output
            </button>
        {% endif %}
        <div class="card mb-3 {% if selectedJudging is null or selectedJudging.result != 'compiler-error' %}collapse{% endif%}"
             id="detailcompile">
            <div class="card-header">Compilation output</div>
            {% if output is empty %}
                <div class="card-body nodata">There were no compiler errors or warnings.</div>
            {% else %}
                <div class="card-body"><pre class="output_text">{{ output }}</pre></div>
            {% endif %}
        </div>

        <div class="mb-2">
            {# Display testcase results #}
            {% if externalJudgement is not null or (selectedJudging is not null and selectedJudging.result != 'compiler-error') %}
                <table>
                    {% if not submission.importError %}
                        <tr>
                            <td>
                                {% if selectedJudging is null %}
                                    {% set judgingDone = false %}
                                {% else %}
                                    {% set judgingDone = selectedJudging.endtime is not empty %}
                                {% endif %}
                                {{ runs | displayTestcaseResults(judgingDone) }}
                            </td>
                            <td>
                                {% if selectedJudging is not null and runsOutstanding %}
                                    {% if selectedJudging.judgeCompletely %}
                                        <i class="fas fa-balance-scale" title="remaining test cases requested to be judged"></i>
                                    {% elseif selectedJudging.result is not null or isAnalystMode %}
                                        <form action="{{ path('jury_submission_request_remaining', {'judgingId': selectedJudging.judgingid}) }}" method="post"
                                              style="display: inline; ">
                                            <button type="submit" class="btn btn-outline-secondary btn-sm" style="padding: 0.1rem 0.5rem; font-size: 0.7em"><i class="fa-solid fa-gavel"></i> judge remaining</button>
                                        </form>
                                    {% endif %}
                                {% endif %}
                            </td>
                        </tr>
                    {% endif %}
                    {% if externalJudgement is not null %}
                        <tr>
                            <td>
                                {{ externalRuns | displayTestcaseResults(externalJudgement.endtime is not empty, true) }}
                            </td>
                            <td>
                                {% if externalSubmissionUrl is defined and externalSubmissionUrl is not empty %}
                                    <a href="{{ externalSubmissionUrl }}">
                                {% endif %}
                                external
                                {% if externalSubmissionUrl is defined and externalSubmissionUrl is not empty %}
                                    </a>
                                {% endif %}
                            </td>
                        </tr>
                    {% endif %}
                    {% if lastJudging is not null %}
                        <tr class="lasttcruns">
                            <td>
                                {{ lastRuns | displayTestcaseResults(lastJudging.endtime is not empty) }}
                            </td>
                            <td>
                                <a href="{{ lastSubmissionLink }}">previous {{ lastSubmission.externalid }}</a>
                                {% if lastJudging.verifyComment %}
                                    <span class="prevsubmit">(verify comment: '{{ lastJudging.verifyComment }}')</span>
                                {% endif %}
                            </td>
                        </tr>
                    {% endif %}
                </table>

            {% endif %}
        </div>

        {% if scoringHierarchy is defined and scoringHierarchy is not empty %}
            <div class="mb-3">
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseScoringDetails" aria-expanded="false" aria-controls="collapseScoringDetails">
                    <i class="fas fa-list-ol mr-1"></i> Show Scoring Details
                </button>
                <div class="collapse mt-2" id="collapseScoringDetails">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>Scoring Details</span>
                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input" type="checkbox" id="precisionToggle">
                                <label class="form-check-label small text-muted" for="precisionToggle">Full precision</label>
                            </div>
                        </div>
                        <div class="card-body scoring-details-container rounded-precision">
                            {{ _self.render_scoring_group(scoringHierarchy, 0) }}
                        </div>
                    </div>
                </div>
            </div>

            <style>
                .scoring-details-container .full-precision { display: none; }
                .scoring-details-container.show-full .rounded-precision { display: none; }
                .scoring-details-container.show-full .full-precision { display: inline; }
            </style>

            <script>
                $(function() {
                    $('#precisionToggle').on('change', function() {
                        $('.scoring-details-container').toggleClass('show-full', this.checked);
                    });
                });
            </script>
        {% endif %}

        {# Show verify info, but only when a result is known #}
        {% if selectedJudging is not null and selectedJudging.result is not empty %}
            {% include 'jury/partials/verify_form.html.twig' with {
                label: 'Verified',
                judging: selectedJudging,
                form_action: path('jury_judging_verify', {judgingId: selectedJudging.judgingid}),
                show_form: not (verificationRequired and selectedJudging.verified and selectedJudging.valid),
                show_icat: true} %}
            {% if submission.contestProblem and icat_url %}
                <script>
                    $(function () {
                        $('#post-to-icat').on('click', function () {
                            postVerifyCommentToICAT(
                                '{{ icat_url }}/insert_entry.php',
                                '{{ app.user.username }}',
                                '{{ submission.team.teamid }}',
                                '{{ submission.contestProblem.shortname }}',
                                '{{ submission.externalid }}'
                            );
                            alert('Comment posted to iCAT.');
                            return false;
                        });
                    });
                </script>
            {% endif %}
        {% elseif selectedJudging is not null %}
            <div class="alert alert-warning">Judging is not ready yet!</div>
        {% endif %}

        {% if (selectedJudging is not null and selectedJudging.result != 'compiler-error')
            or (externalJudgement is not null and externalJudgement.result != 'compiler-error') %}
            {% include 'jury/partials/submission_graph.html.twig' %}
        {% endif %}

        <hr>
        <br>

        {% if externalJudgement is not null or (selectedJudging is not null and selectedJudging.result != 'compiler-error') %}
            {# Show run info. Only when compilation was successful or we have an external judgement #}
            {% for runIdx, run in runs %}
                {% set externalRun = null %}
                {% if externalRuns[runIdx] is defined %}
                    {% set externalRun = externalRuns[runIdx] %}
                {% endif %}
                <div id="run-{{run.rank}}"
                     style="margin-bottom: 20px;"
                     class="card run {% if run.firstJudgingRun and run.firstJudgingRun.runresult == 'correct' %}run_correct{% endif %}">
                    <div class="card-header">
                        Run #{{ run.rank }}
                        {% if run.origInputFilename is not null %}
                            | <span class="filename">{{ run.origInputFilename }}.in</span>
                        {% else %}
                            {% if run.description is not null %}
                                | {{ run.description(true) }}
                            {% endif %}
                        {% endif %}
                        {% if run.firstJudgingRun is not null %}
                            |
                            {% if run.firstJudgingRun.runresult is not null %}
                                <span class="sol {% if run.firstJudgingRun.runresult == 'correct' %}sol_correct{% else %}sol_incorrect{% endif %}">
                                    {{ run.firstJudgingRun.runresult }}
                                </span>
                                {% if run.firstJudgingRun.runresult == 'timelimit' %}
                                    {% if runsOutput[runIdx].terminated %}
                                        <b>(terminated)</b>
                                    {% else %}
                                        <b>(finished late)</b>
                                    {% endif %}
                                {% endif %}
                            {% else %}
                                <span class="sol sol_queued">
                                   {% if runsOutput[runIdx].hostname is null %}
                                       queued
                                   {% else %}
                                       judging
                                   {% endif %}
                                </span>
                            {% endif %}
                            {% if submission.problem.scoringProblem %}
                                | Score:
                                {% if run.firstJudgingRun.score is not null %}
                                    {{ "%.2f" | format(run.firstJudgingRun.score) }}
                                {% else %}
                                    -
                                {% endif %}
                            {% endif %}
                        {% endif %}
                        {% if runsOutput[runIdx].hostname is not null %}
                            {% set judgehostLink = path('jury_judgehost', {judgehostid: runsOutput[runIdx].judgehostid}) %}
                            | <a href="{{ judgehostLink }}">{{ runsOutput[runIdx].hostname | printHost }}</a>
                        {% endif %}
                        {% if externalRun is not null and externalRun.firstExternalRun is not null %}
                            {% if externalRun.firstExternalRun is not null %}
                                (external:
                                <span class="sol {% if externalRun.firstExternalRun.result == 'correct' %}sol_correct{% else %}sol_incorrect{% endif %}">
                                    {{ externalRun.firstExternalRun.result }}{#-
                                -#}</span>{#-
                                -#})
                            {% endif %}
                        {% endif %}
                        {% if runsOutput[runIdx].testcasedir is defined and runsOutput[runIdx].testcasedir is not null %}
                          | <code>.../{{ runsOutput[runIdx].testcasedir | split('/') | last }}</code>{#-
                            -#}<button type="button" class="btn btn-link" onclick="navigator.clipboard.writeText('{{ runsOutput[runIdx].testcasedir }}')"><i class="fa-regular fa-copy"></i></button>
                        {% endif %}
                        <div style="float: right;">
                            <a href="{{ path('jury_problem_testcase_fetch', {'probId': submission.problem.externalid, 'rank': run.rank, 'type': 'input'}) }}">
                                <button class="btn btn-sm btn-outline-secondary" >
                                    <i class="fas fa-download"></i>
                                    Input
                                </button>
                            </a>
                            <a href="{{ path('jury_problem_testcase_fetch', {'probId': submission.problem.externalid, 'rank': run.rank, 'type': 'output'}) }}">
                                <button class="btn btn-sm btn-outline-secondary" >
                                    <i class="fas fa-download"></i>
                                    Reference Output
                                </button>
                            </a>
                            {% if run.firstJudgingRun is not null %}
                                <a href="{{ path('jury_submission_team_output', {'submission': submission.externalid, 'run': run.firstJudgingRun.runid, 'contest': submission.contest.externalid}) }}">
                                    <button class="btn btn-sm btn-outline-secondary" >
                                        <i class="fas fa-download"></i>
                                        {% if runsOutput[runIdx].is_output_run_truncated_in_db %}
                                            Truncated
                                        {% endif %}
                                        Team Output
                                    </button>
                                </a>
                                {% if runsOutput[runIdx].is_output_run_truncated_in_db %}
                                    <a href="{{ path('request_output', {'jid': run.firstJudgingRun.judgingid, 'jrid': run.firstJudgingRun.runid}) }}">
                                        <button class="btn btn-sm btn-outline-secondary" >
                                            <i class="fas fa-upload"></i>
                                            Retrieve Full Team Output
                                        </button>
                                    </a>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-body">
                    {% if run.firstJudgingRun is not null %}
                        {% if run.firstJudgingRun.runresult != 'correct' and isMultiPassProblem %}
                            <div class="alert alert-warning">Note that this is a multi-pass problem, and only data of the failing pass is presented.</div>
                        {% endif %}
                        {{ runsOutput[runIdx].metadata | printMetadata }}
                        <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse"
                                data-bs-target="#collapseExample-{{ runIdx }}"
                                aria-expanded="false">
                            show complete metadata
                        </button>
                        {% if runsOutput[runIdx].metadata is not null %}
                            {% if runsOutput[runIdx].output_limit is defined and runsOutput[runIdx].output_limit %}
                                <div class="alert alert-warning">
                                    The submission output (<code>{{ runsOutput[runIdx].output_limit }}</code>) was
                                    truncated because of the configured output limit.
                                </div>
                            {% endif %}
                            <div class="collapse" id="collapseExample-{{ runIdx }}">
                                  <div class="card card-body output_text">{{ runsOutput[runIdx].metadata }}</div>
                            </div>
                        {% endif %}
                    </span>
                    {% endif %}
                    {% if run.description is not null %}
                        <p><em>
                            {{ run.description(true) | descriptionExpand }}
                        </em></p>
                    {% endif %}
                    {% if runsOutput[runIdx].image_thumb %}
                        <span style="float:right; border: 3px solid #438ec3; margin: 5px; padding: 5px;">
                            {% set imgUrl = path('jury_problem_testcase_fetch', {'probId': submission.problem.externalid, 'rank': run.rank, 'type': 'image'}) %}
                            <a href="{{ imgUrl }}">
                                <img class="image_thumb" src="data:{{ run.imageType | extensionToMime }};base64,{{ runsOutput[runIdx].image_thumb | base64 }}"/>
                            </a>
                        </span>
                    {% endif %}

                    {% set runDone = false %}
                    {% if run is not null and run.firstJudgingRun is not null and run.firstJudgingRun.runresult is not null %}
                        {% set runDone = true %}
                    {% endif %}
                    {% if not runDone %}
                        <p class="nodata">
                            {% if selectedJudging is not null and selectedJudging.result %}
                                Run not used for final result.
                            {% else %}
                                Run not started/finished yet.
                            {% endif %}
                        </p>
                    {% else %}
                        {% if run.firstJudgingRun is not null and run.firstJudgingRun.runresult is not null %}
                            {% if combinedRunCompare %}
                                <h5>Validator output</h5>
                                {% if runsOutput[runIdx].output_diff is empty %}
                                    <p class="nodata">There was no validator output.</p>
                                {% else %}
                                    <pre class="output_text">{{ runsOutput[runIdx].output_diff }}</pre>
                                {% endif %}
                            {% else %}
                                <h5>Diff output</h5>
                                {% if runsOutput[runIdx].output_diff is empty %}
                                    <p class="nodata">There was no diff output.</p>
                                {% else %}
                                    <pre class="output_text">{{ runsOutput[runIdx].output_diff }}</pre>
                                {% endif %}

                                {% if run.firstJudgingRun.runresult != 'correct' %}
                                    {{ runsOutput[runIdx] | runDiff }}
                                {% endif %}
                            {% endif %}

                            {% if combinedRunCompare %}
                                <h5>Validator/Submission interaction</h5>
                                {% if runsOutput[runIdx].output_run is empty %}
                                    <p class="nodata">There was no interaction log.</p>
                                {% else %}
                                    {{ runsOutput[runIdx].output_run | interactiveLog }}
                                {% endif %}
                            {% else %}
                                <h5>Program output</h5>
                                {% if runsOutput[runIdx].output_run is empty %}
                                    <p class="nodata">There was no program output.</p>
                                {% else %}
                                    <pre class="output_text">{{ runsOutput[runIdx].output_run }}</pre>
                                {% endif %}
                            {% endif %}

                            <h5>Program error output</h5>
                            {% if runsOutput[runIdx].output_error is empty %}
                                <p class="nodata">There was no stderr output.</p>
                            {% else %}
                                <pre class="output_text">{{ runsOutput[runIdx].output_error }}</pre>
                            {% endif %}

                            <h5>Judging system output (info/debug/errors)</h5>
                            {% if runsOutput[runIdx].output_system is empty %}
                                <p class="nodata">There was no judging system output.</p>
                            {% else %}
                                <pre class="output_text">{{ runsOutput[runIdx].output_system }}</pre>
                            {% endif %}

                            {% if runsOutput[runIdx].team_message is not empty %}
                                <h5>Judge message for the team</h5>
                                <pre class="output_text">
{{  runsOutput[runIdx].team_message }}</pre>
                            {%  endif %}
                        {% endif %}

                        {% if runsOutput[runIdx].validatorMetadata is not empty %}
                            <hr/>
                            <h5>Validator metadata</h5>
                            {{ runsOutput[runIdx].validatorMetadata | printMetadata }}
                            <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse"
                                    data-bs-target="#collapseValMeta-{{ runIdx }}"
                                    aria-expanded="false">
                                show complete validator metadata
                            </button>
                            <div class="collapse" id="collapseValMeta-{{ runIdx }}">
                                <div class="card card-body output_text">{{ runsOutput[runIdx].validatorMetadata  }}</div>
                            </div>

                        {% endif %}
                    {% endif %}

                    </div>
                </div>
            {% endfor %}

            <script>
                function display_correctruns(show) {
                    elements = document.getElementsByClassName('run_correct');
                    for (var i = 0; i < elements.length; i++) {
                        elements[i].style.display = show ? 'block' : 'none';
                    }
                }

                display_correctruns(false);
            </script>
        {% endif %} {# selectedJudging.result != 'compiler-error' #}

    {% endif %} {# selectedJudging is not null or externalJudgement is not null #}

{% endblock %}
