ifndef TOPDIR
TOPDIR=..
endif
include $(TOPDIR)/Makefile.global

EXECDIRS=$(shell find files -mindepth 2 -maxdepth 2 -type d)
ZIPFILES=$(EXECDIRS:=.zip)
ZIPSQL=mysql_db_files_defaultdata.sql mysql_db_files_examples.sql

domserver: dj-setup-database

# Use secondary expansion to use stem $* in dependencies:
.SECONDEXPANSION:
$(ZIPFILES): %.zip: $$(wildcard $$*/*)
	@rm -f $@
	zip -qjr $@ $*

$(TOPDIR)/doc/examples/.pdf-generated:
	$(MAKE) -C $(TOPDIR)/doc/examples .pdf-generated

$(ZIPSQL): $(TOPDIR)/doc/examples/.pdf-generated
$(ZIPSQL): $(ZIPFILES)
	@[ -n "$(QUIET)" ] || echo "Generating '$@'..."
	@rm -f $@
	@echo "-- Generated by make on `date`\n" >> $@
	@type=`echo $@ | sed 's/mysql_db_files_\(.*\)\.sql/\1/'` ; \
	for i in files/$$type/*.zip ; do \
		[ -n "$(QUIET)" ] || echo "  adding '$$i'" ; \
		printf "UPDATE executable SET zipfile = 0x%s, md5sum = '%s' WHERE execid = '%s';\n" "`hexdump -v -e '/1 \"%02X\"' $$i`" "`md5sum $$i | cut -f1 -d\\ `" "`basename $$i .zip`" >> $@ ; \
	done ; \
	if [ "$$type" = "examples" ]; then \
		echo >> $@ ; \
		for i in $(TOPDIR)/doc/examples/*.pdf ; do \
			[ -n "$(QUIET)" ] || echo "  adding '$$i'" ; \
			f=`basename $$i` ; \
			prob="$${f%.*}" ; \
			ext="$${f#$prob}" ; \
			printf "UPDATE problem SET problemtext = 0x%s, problemtext_type = '$$ext' WHERE shortname = '$$prob';\n" "`hexdump -v -e '/1 \"%02X\"' $$i`" >> $@ ; \
		done ; \
	fi

dj-setup-database: %: %.in $(TOPDIR)/paths.mk
	$(substconfigvars)
	chmod a+x $@

install-domserver:
	$(INSTALL_PROG) -t $(DESTDIR)$(domserver_bindir) dj-setup-database
	$(INSTALL_DATA) -t $(DESTDIR)$(domserver_sqldir) \
		mysql_db_structure.sql mysql_db_defaultdata.sql mysql_db_examples.sql \
		$(ZIPSQL)
	$(INSTALL_DATA) -t $(DESTDIR)$(domserver_sqldir)/upgrade \
	 	upgrade/upgrade_*.sql upgrade/README

	$(INSTALL_DIR) $(addprefix $(DESTDIR)$(domserver_sqldir)/files/,defaultdata examples)
	$(INSTALL_DATA) -t $(DESTDIR)$(domserver_sqldir)/files/defaultdata \
	 	files/defaultdata/*.zip
	$(INSTALL_DATA) -t $(DESTDIR)$(domserver_sqldir)/files/examples \
	 	files/examples/*.zip

dist-l: $(ZIPSQL) $(ZIPFILES)

distclean-l:
	-rm -f dj-setup-database

maintainer-clean-l:
	-rm -f $(ZIPSQL) $(ZIPFILES)
