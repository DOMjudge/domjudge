#!/bin/sh
# This script will create cgroups for DOMjudge to use in /sys/fs/cgroup/
# They need to be re-created after system boot; you may want to
# add this script to an init script.

# Change the following to the user you start the judgedaemon as.
# (hence: not the 'domjudge-run' user!)

JUDGEHOSTUSER=@DOMJUDGE_USER@
CGROUPBASE="/sys/fs/cgroup"

cgroup_error_and_usage () {
    echo "$1" >&2
    echo "Unable to continue. To fix this, you most likely need to follow these steps:
    1. In /etc/default/grub, add 'cgroup_enable=memory swapaccount=1' to GRUB_CMDLINE_LINUX_DEFAULT.
    2. Run update-grub
    3. Reboot" >&2
    exit 1
}

# Check whether cgroup v2 is enabled.
fs_type=$(awk '$2 == "/sys/fs/cgroup" {print $3}' /proc/mounts)
if [ "$fs_type" = "cgroup2" ]; then
    kernel_version=$(uname -r)
    major=$(echo "$kernel_version" | cut -d '.' -f 1)
    minor=$(echo "$kernel_version" | cut -d '.' -f 2)
    if [ "$major" -lt 5 ] || { [ "$major" -eq 5 ] && [ "$minor" -lt 19 ]; }; then
        cgroup_error_and_usage "Error: kernel ($kernel_version) is too old to record peak RAM usage with cgroup V2."
    fi
    if ! echo "+memory" >> /sys/fs/cgroup/cgroup.subtree_control; then
        cgroup_error_and_usage "Error: Cannot add +memory to cgroup.subtree_control; check kernel params."
    fi
    if ! echo "+cpuset" >> /sys/fs/cgroup/cgroup.subtree_control; then
        cgroup_error_and_usage "Error: Cannot add +cpuset to cgroup.subtree_control; check kernel params."
    fi
    if grep -q ":/$" /proc/self/cgroup; then
        cgroup_error_and_usage "Error: Cgroups not configured properly, missing cgroup hierarchy prefix under /proc/self/cgroup. If running in a container, make sure to set cgroupns=host."
    fi
else
    cgroup_error_and_usage "Error: Cgroups not configured properly, did not find cgroup v2 in /sys/fs/cgroup but '$fs_type'."
fi
